<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: PaymentController</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">PaymentController</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/controllers/payment_controller_rb.html">
                app/controllers/payment_controller.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="ApplicationController.html">
                ApplicationController
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000020">carpark_csv</a>&nbsp;&nbsp;
      <a href="#M000019">carpark_passes</a>&nbsp;&nbsp;
      <a href="#M000015">create</a>&nbsp;&nbsp;
      <a href="#M000016">delete</a>&nbsp;&nbsp;
      <a href="#M000006">edit</a>&nbsp;&nbsp;
      <a href="#M000009">gruff_todate</a>&nbsp;&nbsp;
      <a href="#M000010">gruff_total_mems</a>&nbsp;&nbsp;
      <a href="#M000011">list2007_by_name</a>&nbsp;&nbsp;
      <a href="#M000007">list_by_member_class</a>&nbsp;&nbsp;
      <a href="#M000012">listytd</a>&nbsp;&nbsp;
      <a href="#M000014">new</a>&nbsp;&nbsp;
      <a href="#M000018">overdue_csv</a>&nbsp;&nbsp;
      <a href="#M000017">overduememberships</a>&nbsp;&nbsp;
      <a href="#M000008">tot_by_member_class</a>&nbsp;&nbsp;
      <a href="#M000021">tot_by_member_class2</a>&nbsp;&nbsp;
      <a href="#M000013">update</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000020" class="method-detail">
        <a name="M000020"></a>

        <div class="method-heading">
          <a href="#M000020" class="method-signature">
          <span class="method-name">carpark_csv</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000020-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000020-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 505</span>
505:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">carpark_csv</span>
506:    <span class="ruby-identifier">this_yr_start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span> 
507:   
508:     <span class="ruby-ivar">@carpark</span> = <span class="ruby-constant">Member</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-node">&quot;select * from 
509: (
510: SELECT   peo.first_name, peo.last_name, peo.home_phone, 
511:          peo.mobile_phone, peo.email_addr, mem.member_class, 
512:          pay.date_lodged , concat( peo.member_id,'001') as car_park_id
513: FROM     people peo, 
514:          members mem, 
515:          payments pay,
516:          privileges priv 
517:          
518: WHERE    peo.member_id=mem.id 
519: AND      pay.member_id=peo.member_id 
520: and      mem.member_class = priv.member_class
521: AND      peo.status = 'm' 
522: AND      pay.date_lodged &gt;= '#{this_yr_start}'  
523: AND      pay.date_lodged = ( SELECT MAX(b.date_lodged) FROM payments b WHERE b.member_id = pay.member_id )
524: and      priv.car_park = 'Y' 
525: order by pay.date_lodged
526: ) one 
527: union 
528: select * from 
529: (
530: SELECT   peo.first_name, peo.last_name, peo.home_phone, 
531:          peo.mobile_phone, peo.email_addr, mem.member_class, 
532:          pay.date_lodged ,concat( peo.member_id,'002') as car_park_id
533: FROM     people peo, 
534:          members mem, 
535:          payments pay,
536:          privileges priv 
537:          
538: WHERE    peo.member_id=mem.id 
539: AND      pay.member_id=peo.member_id 
540: and      mem.member_class = priv.member_class
541: AND      peo.status = 'p' 
542: AND      pay.date_lodged &gt;=  '#{this_yr_start}' 
543: AND      pay.date_lodged = ( SELECT MAX(b.date_lodged) FROM payments b WHERE b.member_id = pay.member_id )
544: and      priv.car_park = 'Y' 
545: and      priv.votes = 2
546: order by pay.date_lodged
547: )two;&quot;</span>)
548:   
549:   <span class="ruby-identifier">report</span> = <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>
550:   <span class="ruby-constant">CSV</span><span class="ruby-operator">::</span><span class="ruby-constant">Writer</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-identifier">report</span>,<span class="ruby-value str">','</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">title</span><span class="ruby-operator">|</span>
551: 
552:   <span class="ruby-identifier">title</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-value str">'First Name'</span>, <span class="ruby-value str">'Last Name'</span>, <span class="ruby-value str">'Home Phone'</span>, <span class="ruby-value str">'Mobile'</span>, <span class="ruby-value str">'Email'</span>, <span class="ruby-value str">'Member Class'</span>, <span class="ruby-value str">'last Payment date'</span>,<span class="ruby-value str">'Car Park ID'</span>]
553:     <span class="ruby-ivar">@carpark</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
554:       <span class="ruby-identifier">title</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">c</span>.<span class="ruby-identifier">first_name</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">last_name</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">home_phone</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">mobile_phone</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">email_addr</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">member_class</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">date_lodged</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">car_park_id</span>]
555:     <span class="ruby-keyword kw">end</span>
556: 
557:   <span class="ruby-keyword kw">end</span>
558:   <span class="ruby-identifier">report</span>.<span class="ruby-identifier">rewind</span>
559:   <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">report</span>.<span class="ruby-identifier">read</span>,<span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'text/csv; charset=iso-8859-1; header=present'</span>,<span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'carpark.csv'</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>)
560: 
561: 
562: 
563: <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000019" class="method-detail">
        <a name="M000019"></a>

        <div class="method-heading">
          <a href="#M000019" class="method-signature">
          <span class="method-name">carpark_passes</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000019-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000019-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 453</span>
453:  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">carpark_passes</span>
454:    <span class="ruby-identifier">this_yr_start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span> 
455:    
456:    
457:   <span class="ruby-ivar">@carpark</span> = <span class="ruby-constant">Member</span>.<span class="ruby-identifier">find_by_sql</span>(<span class="ruby-node">&quot;select * from 
458: (
459: SELECT   peo.member_id, peo.first_name, peo.last_name, peo.home_phone, 
460:          peo.mobile_phone, peo.email_addr, mem.member_class, 
461:          pay.date_lodged , concat( peo.member_id,'001') as car_park_id
462: FROM     people peo, 
463:          members mem, 
464:          payments pay,
465:          privileges priv 
466:          
467: WHERE    peo.member_id=mem.id 
468: AND      pay.member_id=peo.member_id 
469: and      mem.member_class = priv.member_class
470: AND      peo.status = 'm' 
471: AND      pay.date_lodged &gt;= '#{this_yr_start}' 
472: AND      pay.date_lodged = ( SELECT MAX(b.date_lodged) FROM payments b WHERE b.member_id = pay.member_id )
473: and      priv.car_park = 'Y' 
474: order by pay.date_lodged
475: ) one 
476: union 
477: select * from 
478: (
479: SELECT    peo.member_id, peo.first_name, peo.last_name, peo.home_phone, 
480:          peo.mobile_phone, peo.email_addr, mem.member_class, 
481:          pay.date_lodged ,concat( peo.member_id,'002') as car_park_id
482: FROM     people peo, 
483:          members mem, 
484:          payments pay,
485:          privileges priv 
486:          
487: WHERE    peo.member_id=mem.id 
488: AND      pay.member_id=peo.member_id 
489: and      mem.member_class = priv.member_class
490: AND      peo.status = 'p' 
491: AND      pay.date_lodged &gt;= '#{this_yr_start}' 
492: AND      pay.date_lodged = ( SELECT MAX(b.date_lodged) FROM payments b WHERE b.member_id = pay.member_id )
493: and      priv.car_park = 'Y' 
494: and      priv.votes = 2
495: order by pay.date_lodged
496: )two;&quot;</span>)
497: 
498:   
499:   <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
500:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
501:   <span class="ruby-keyword kw">end</span>
502:   
503: <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000015" class="method-detail">
        <a name="M000015"></a>

        <div class="method-heading">
          <a href="#M000015" class="method-signature">
          <span class="method-name">create</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000015-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000015-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 346</span>
346:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create</span>
347:     <span class="ruby-ivar">@payment</span> = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:payment</span>])
348:     <span class="ruby-comment cmt">#@person = person.find_by_status &quot;m&quot; ,:conditions =&gt; &quot;person.member_id = #'(fess)'&quot;</span>
349:     
350:     <span class="ruby-ivar">@member</span> = <span class="ruby-constant">Member</span>.<span class="ruby-identifier">membership</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:payment</span>][<span class="ruby-identifier">:member_id</span>])
351:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
352:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@payment</span>.<span class="ruby-identifier">save</span>
353:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@payment</span>.<span class="ruby-identifier">paymenttype_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> 
354:           <span class="ruby-ivar">@member</span>.<span class="ruby-identifier">renew_date</span> = <span class="ruby-ivar">@payment</span>.<span class="ruby-identifier">date_lodged</span>
355:           <span class="ruby-ivar">@member</span>.<span class="ruby-identifier">save</span>
356:         <span class="ruby-keyword kw">end</span>
357:         <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Payment Successfully Created.'</span>
358:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@member</span>.<span class="ruby-identifier">privilege_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@payment</span>.<span class="ruby-identifier">privilege_id</span>
359:            <span class="ruby-ivar">@member</span>.<span class="ruby-identifier">privilege_id</span> = <span class="ruby-ivar">@payment</span>.<span class="ruby-identifier">privilege_id</span>
360:            <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@member</span>.<span class="ruby-identifier">save</span> 
361:              <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Payment Successfully Created, Membership Class updated.'</span>
362:            <span class="ruby-keyword kw">end</span>
363:         <span class="ruby-keyword kw">end</span>
364:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span><span class="ruby-value str">'person'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>,<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Person</span>.<span class="ruby-identifier">main_person</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:payment</span>][<span class="ruby-identifier">:member_id</span>]).<span class="ruby-identifier">id</span>   }
365:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@person</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:created</span>, <span class="ruby-identifier">:location</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@person</span> }
366:       <span class="ruby-keyword kw">else</span>
367:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;new&quot;</span> }
368:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">errors</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:unprocessable_entity</span> }
369:       <span class="ruby-keyword kw">end</span>
370:     <span class="ruby-keyword kw">end</span>
371:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000016" class="method-detail">
        <a name="M000016"></a>

        <div class="method-heading">
          <a href="#M000016" class="method-signature">
          <span class="method-name">delete</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000016-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000016-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 379</span>
379:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete</span>
380:     <span class="ruby-identifier">pm</span> = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
381:     <span class="ruby-ivar">@pid</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:pid</span>]
382:     <span class="ruby-identifier">pm</span>.<span class="ruby-identifier">destroy</span>
383:     
384:     
385:     <span class="ruby-identifier">m</span> = <span class="ruby-constant">Member</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:first</span> ,<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;id = '#{pm.member_id}'&quot;</span>
386:     
387:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pm</span>.<span class="ruby-identifier">paymenttype_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> 
388:       <span class="ruby-identifier">prevpay</span> = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:first</span>,<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;member_id = '#{pm.member_id}'&quot;</span>,<span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;date_lodged DESC &quot;</span>
389:       
390:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">prevpay</span> 
391:             <span class="ruby-identifier">m</span>.<span class="ruby-identifier">renew_date</span> = <span class="ruby-identifier">prevpay</span>.<span class="ruby-identifier">date_lodged</span> 
392:             <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Payment Deleted - Resetting renewed date.'</span>  
393:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">prevpay</span>.<span class="ruby-identifier">privilege_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">privilege_id</span>
394:            <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Warning; Resetting membership type to that of previous payment.'</span> 
395:            <span class="ruby-identifier">m</span>.<span class="ruby-identifier">privilege_id</span> = <span class="ruby-identifier">prevpay</span>.<span class="ruby-identifier">privilege_id</span>
396:         <span class="ruby-keyword kw">end</span>
397:        <span class="ruby-identifier">m</span>.<span class="ruby-identifier">save</span>
398:       <span class="ruby-keyword kw">end</span> 
399:     <span class="ruby-keyword kw">else</span>
400:        <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Payment Deleted'</span>
401:     <span class="ruby-keyword kw">end</span>
402:  
403:  <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'person'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>,<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@pid</span>
404:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000006" class="method-detail">
        <a name="M000006"></a>

        <div class="method-heading">
          <a href="#M000006" class="method-signature">
          <span class="method-name">edit</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>=================================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000006-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000006-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 5</span>
 5:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit</span>
 6:     <span class="ruby-comment cmt"># get here from Person#edit</span>
 7: 
 8:     <span class="ruby-ivar">@pm</span> = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
 9: 
10:     <span class="ruby-ivar">@m</span> = <span class="ruby-ivar">@pm</span>.<span class="ruby-identifier">member</span>
11:     <span class="ruby-ivar">@person</span> = <span class="ruby-ivar">@m</span>.<span class="ruby-identifier">people</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;status = 'm'&quot;</span>
12:     <span class="ruby-ivar">@pid</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:pid</span>]
13:     
14:     <span class="ruby-comment cmt"># although a payment is linked to a member, not a person, the entry</span>
15:     <span class="ruby-comment cmt">#   point for editing a member is the person who is the principal member</span>
16:     <span class="ruby-comment cmt">#   hence the need to track :pid</span>
17:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000009" class="method-detail">
        <a name="M000009"></a>

        <div class="method-heading">
          <a href="#M000009" class="method-signature">
          <span class="method-name">gruff_todate</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000009-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000009-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 93</span>
 93: <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gruff_todate</span>
 94:   
 95:   <span class="ruby-identifier">require</span> <span class="ruby-value str">'gruff'</span>
 96: 
 97:   <span class="ruby-identifier">g</span> = <span class="ruby-constant">Gruff</span><span class="ruby-operator">::</span><span class="ruby-constant">Bar</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'480x275'</span>)
 98:   <span class="ruby-identifier">g</span>.<span class="ruby-identifier">title</span> = <span class="ruby-value str">&quot;Totals Year To Date&quot;</span>
 99: 
100:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">theme</span> = {
101:        <span class="ruby-identifier">:colors</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'#ff6600'</span>, <span class="ruby-value str">'#3bb000'</span>, <span class="ruby-value str">'#1e90ff'</span>, <span class="ruby-value str">'#efba00'</span>, <span class="ruby-value str">'#0aaafd'</span>],
102:        <span class="ruby-identifier">:marker_color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'#aaa'</span>,
103:        <span class="ruby-identifier">:background_colors</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'#eaeaea'</span>, <span class="ruby-value str">'#fff'</span>]
104:      }
105:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">hide_title</span> = <span class="ruby-keyword kw">false</span>
106:     
107:     
108:     <span class="ruby-comment cmt">#Start year is 2007</span>
109:     <span class="ruby-identifier">years</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">2006</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> 
110:     <span class="ruby-ivar">@types</span> = []
111:    
112:     <span class="ruby-identifier">years</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">y</span><span class="ruby-operator">|</span>
113:       <span class="ruby-identifier">date_start</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>
114:       <span class="ruby-identifier">date_end</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">month</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">day</span>.<span class="ruby-identifier">to_s</span>
115:       
116:       <span class="ruby-ivar">@types</span>[<span class="ruby-identifier">y</span>] = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">count</span>  <span class="ruby-identifier">:all</span>,  
117:                             <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;inner join privileges ON privileges.id = payments.privilege_id&quot;</span>, 
118:                             <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-node">&quot;date_lodged &gt;= '#{date_start}' AND date_lodged &lt;= '#{date_end}' and member_class not in ('X','Y','E','R','H','T','L','V' )&quot;</span>, 
119:                             <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'member_class'</span> ,<span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'member_class'</span>
120:      <span class="ruby-keyword kw">end</span>
121:    
122:     <span class="ruby-identifier">classes</span> = []
123:     <span class="ruby-identifier">years</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
124:         <span class="ruby-identifier">classes</span> = (<span class="ruby-ivar">@types</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">keys</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">classes</span>).<span class="ruby-identifier">sort</span>
125:     <span class="ruby-keyword kw">end</span>
126:     <span class="ruby-identifier">keys</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">classes</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">classes</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">v</span>),<span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>] }.<span class="ruby-identifier">flatten</span>]
127:     <span class="ruby-identifier">years</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
128:        <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>((<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">x</span>), <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@types</span>[<span class="ruby-identifier">x</span>][<span class="ruby-identifier">v</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@types</span>[<span class="ruby-identifier">x</span>][<span class="ruby-identifier">v</span>]})
129:     <span class="ruby-keyword kw">end</span>
130:     <span class="ruby-identifier">lab2</span> = []
131:     <span class="ruby-identifier">x</span> = <span class="ruby-value">0</span>
132:     <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
133:        <span class="ruby-identifier">lab2</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">v</span>]
134:     <span class="ruby-keyword kw">end</span>
135:     <span class="ruby-identifier">labels</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">lab2</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">lab2</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">v</span>),<span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>] }.<span class="ruby-identifier">flatten</span>]
136:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">labels</span> = <span class="ruby-identifier">labels</span>
137:     
138:     <span class="ruby-identifier">filename</span> = <span class="ruby-value str">'images/MembershipToDate.png'</span>
139:     
140:     <span class="ruby-comment cmt"># this writes the file to the hard drive for caching</span>
141:     <span class="ruby-comment cmt"># and then writes it to the screen.</span>
142:     <span class="ruby-comment cmt">#</span>
143:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">filename</span>)
144:     <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">to_blob</span>,<span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span><span class="ruby-identifier">filename</span>, <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'image/png'</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'inline'</span>)               
145: 
146:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000010" class="method-detail">
        <a name="M000010"></a>

        <div class="method-heading">
          <a href="#M000010" class="method-signature">
          <span class="method-name">gruff_total_mems</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000010-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000010-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 148</span>
148:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">gruff_total_mems</span>
149:                           
150:   <span class="ruby-identifier">require</span> <span class="ruby-value str">'gruff'</span>
151: 
152:   <span class="ruby-identifier">g</span> = <span class="ruby-constant">Gruff</span><span class="ruby-operator">::</span><span class="ruby-constant">Bar</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">'480x275'</span>)
153:   <span class="ruby-identifier">g</span>.<span class="ruby-identifier">title</span> = <span class="ruby-value str">&quot;Totals by Member Type by Year&quot;</span>
154:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">theme</span> = {
155:        <span class="ruby-identifier">:colors</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'#ff6600'</span>, <span class="ruby-value str">'#3bb000'</span>, <span class="ruby-value str">'#1e90ff'</span>, <span class="ruby-value str">'#efba00'</span>, <span class="ruby-value str">'#0aaafd'</span>],
156:        <span class="ruby-identifier">:marker_color</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'#aaa'</span>,
157:        <span class="ruby-identifier">:background_colors</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'#eaeaea'</span>, <span class="ruby-value str">'#fff'</span>]
158:      }
159:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">hide_title</span> = <span class="ruby-keyword kw">false</span>
160:     
161:     <span class="ruby-comment cmt">#Start year is 2007</span>
162:     <span class="ruby-identifier">years</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">2006</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> 
163:     <span class="ruby-ivar">@types</span> = []
164:     
165:     <span class="ruby-identifier">years</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">y</span><span class="ruby-operator">|</span>
166:     
167:       <span class="ruby-identifier">yr_start</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>
168:       <span class="ruby-identifier">yr_end</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-12-31&quot;</span>
169:       
170:       <span class="ruby-ivar">@types</span>[<span class="ruby-identifier">y</span>] = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">count</span>  <span class="ruby-identifier">:all</span>,  
171:                              <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;inner join privileges ON privileges.id = payments.privilege_id&quot;</span>, 
172:                             <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;date_lodged &gt;= '#{yr_start}' AND date_lodged &lt;= '#{yr_end}' and member_class not in ('X','Y','E','R','H','T','L','V' )&quot;</span>,  
173:                             <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'member_class'</span> ,<span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'member_class ASC'</span>
174: 
175:     <span class="ruby-keyword kw">end</span>
176: 
177: 
178:     <span class="ruby-identifier">classes</span> = []
179:     
180:     <span class="ruby-identifier">years</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
181:        <span class="ruby-identifier">classes</span> = (<span class="ruby-ivar">@types</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">keys</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">classes</span>).<span class="ruby-identifier">sort</span>
182:     <span class="ruby-keyword kw">end</span>
183:     
184:     <span class="ruby-identifier">keys</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">classes</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">classes</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">v</span>),<span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>] }.<span class="ruby-identifier">flatten</span>]
185:     
186:     <span class="ruby-identifier">years</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
187:        <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>((<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">x</span>), <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@types</span>[<span class="ruby-identifier">x</span>][<span class="ruby-identifier">v</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@types</span>[<span class="ruby-identifier">x</span>][<span class="ruby-identifier">v</span>]})
188:     <span class="ruby-keyword kw">end</span>
189:   
190:     <span class="ruby-identifier">lab2</span> = []
191:     <span class="ruby-identifier">x</span> = <span class="ruby-value">0</span>
192:     <span class="ruby-identifier">keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
193:        <span class="ruby-identifier">lab2</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">v</span>]
194:     <span class="ruby-keyword kw">end</span>
195:     <span class="ruby-identifier">labels</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">lab2</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">lab2</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">v</span>),<span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_s</span>] }.<span class="ruby-identifier">flatten</span>]
196:     
197:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">labels</span> = <span class="ruby-identifier">labels</span>
198:   
199:     <span class="ruby-identifier">filename</span> = <span class="ruby-value str">'images/MembershipTotals.png'</span>
200:    
201:     <span class="ruby-comment cmt"># this writes the file to the hard drive for caching</span>
202:     <span class="ruby-comment cmt"># and then writes it to the screen.</span>
203:     <span class="ruby-comment cmt">#</span>
204:    
205:     <span class="ruby-identifier">g</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">filename</span>)
206:     <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">to_blob</span>,<span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span><span class="ruby-identifier">filename</span>, <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'image/png'</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'inline'</span>)               
207:                               
208:                           
209:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000011" class="method-detail">
        <a name="M000011"></a>

        <div class="method-heading">
          <a href="#M000011" class="method-signature">
          <span class="method-name">list2007_by_name</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>=================================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000011-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000011-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 215</span>
215:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">list2007_by_name</span>
216:     <span class="ruby-ivar">@mems</span> = <span class="ruby-constant">Member</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span>[<span class="ruby-identifier">:payments</span>, <span class="ruby-identifier">:people</span>]
217:     <span class="ruby-ivar">@pays1</span> = []
218:     <span class="ruby-ivar">@mbr</span> = []
219:     <span class="ruby-ivar">@mems</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">mem</span><span class="ruby-operator">|</span>
220:       <span class="ruby-identifier">numpays</span> = <span class="ruby-identifier">mem</span>.<span class="ruby-identifier">payments</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
221:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">mem</span>.<span class="ruby-identifier">payments</span>[<span class="ruby-identifier">numpays</span>].<span class="ruby-identifier">date_lodged</span>
222:           <span class="ruby-identifier">dd</span> = <span class="ruby-identifier">mem</span>.<span class="ruby-identifier">payments</span>[<span class="ruby-identifier">numpays</span>].<span class="ruby-identifier">date_lodged</span>.<span class="ruby-identifier">to_date</span>
223:           <span class="ruby-keyword kw">if</span>  <span class="ruby-identifier">dd</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value str">'2007-01-01'</span>.<span class="ruby-identifier">to_date</span> 
224:             <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">dd</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value str">'2008-01-01'</span>.<span class="ruby-identifier">to_date</span>
225:               <span class="ruby-identifier">numpays</span> = <span class="ruby-identifier">numpays</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
226:             <span class="ruby-keyword kw">end</span>
227:             <span class="ruby-ivar">@mbr</span> = []
228:             
229:             <span class="ruby-identifier">mem</span>.<span class="ruby-identifier">people</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pers</span><span class="ruby-operator">|</span>
230:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pers</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'m'</span>
231:                 <span class="ruby-ivar">@mbr</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pers</span>.<span class="ruby-identifier">last_name</span>
232:                 <span class="ruby-ivar">@mbr</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">pers</span>.<span class="ruby-identifier">first_name</span>
233:               <span class="ruby-keyword kw">end</span>
234:             <span class="ruby-keyword kw">end</span>
235:             <span class="ruby-ivar">@mbr</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">mem</span>.<span class="ruby-identifier">member_num</span>
236:             <span class="ruby-ivar">@mbr</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">mem</span>.<span class="ruby-identifier">payments</span>[<span class="ruby-identifier">numpays</span>].<span class="ruby-identifier">date_lodged</span>.<span class="ruby-identifier">to_date</span>
237:             <span class="ruby-ivar">@mbr</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">mem</span>.<span class="ruby-identifier">payments</span>[<span class="ruby-identifier">numpays</span>].<span class="ruby-identifier">amount</span>
238:             <span class="ruby-ivar">@mbr</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">mem</span>.<span class="ruby-identifier">payments</span>[<span class="ruby-identifier">numpays</span>].<span class="ruby-identifier">member_class</span>
239:             <span class="ruby-ivar">@pays1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@mbr</span>
240:           <span class="ruby-keyword kw">end</span>
241:         <span class="ruby-keyword kw">end</span>
242:     <span class="ruby-keyword kw">end</span>
243: <span class="ruby-comment cmt">#    @pays = @pays1.sort do |a,b| </span>
244: <span class="ruby-comment cmt">#      x = a[0].to_s</span>
245: <span class="ruby-comment cmt">#      y = b[0].to_s</span>
246: <span class="ruby-comment cmt">#      x &lt;=&gt; y </span>
247: <span class="ruby-comment cmt">#    end</span>
248: <span class="ruby-comment cmt">#    </span>
249: <span class="ruby-comment cmt">#    Sort by amount</span>
250: <span class="ruby-comment cmt">#   @pays = @pays1.sort { |a,b| a[4].to_i &lt;=&gt; b[4].to_i}</span>
251: <span class="ruby-comment cmt">#</span>
252: <span class="ruby-comment cmt">#   Sort by last_name</span>
253: <span class="ruby-comment cmt">#   @pays = @pays1.sort { |a,b| a[0].to_s &lt;=&gt; b[0].to_s}</span>
254: <span class="ruby-comment cmt">#   </span>
255: <span class="ruby-comment cmt">#   Sort by last_name and first_name</span>
256:    <span class="ruby-ivar">@pays</span> = <span class="ruby-ivar">@pays1</span>.<span class="ruby-identifier">sort</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">a</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">a</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_s</span>).<span class="ruby-identifier">downcase</span> <span class="ruby-operator">&lt;=&gt;</span> (<span class="ruby-identifier">b</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">b</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_s</span>).<span class="ruby-identifier">downcase</span>}
257:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000007" class="method-detail">
        <a name="M000007"></a>

        <div class="method-heading">
          <a href="#M000007" class="method-signature">
          <span class="method-name">list_by_member_class</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>=================================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000007-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000007-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 20</span>
20:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">list_by_member_class</span>
21:     <span class="ruby-identifier">this_yr_start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>  
22:     <span class="ruby-ivar">@pays</span> = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,  <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:privilege</span> ,<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;date_lodged &gt; '#{this_yr_start}'&quot;</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'privileges.class_desc, date_lodged'</span> 
23:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000012" class="method-detail">
        <a name="M000012"></a>

        <div class="method-heading">
          <a href="#M000012" class="method-signature">
          <span class="method-name">listytd</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>=================================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000012-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000012-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 263</span>
263:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">listytd</span>
264:     <span class="ruby-identifier">dt_strt</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-12-31&quot;</span>
265:     
266:     <span class="ruby-ivar">@pays</span> = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,  <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;date_lodged &gt; '#{dt_strt}' &quot;</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'date_lodged'</span> 
267:   
268:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
269:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
270:       <span class="ruby-comment cmt">#format.xml { render :xml=&gt;@pays } </span>
271:       
272:     <span class="ruby-keyword kw">end</span>
273:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000014" class="method-detail">
        <a name="M000014"></a>

        <div class="method-heading">
          <a href="#M000014" class="method-signature">
          <span class="method-name">new</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000014-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000014-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 335</span>
335:    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new</span>
336:     <span class="ruby-ivar">@payment</span> = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">new</span>
337:     <span class="ruby-ivar">@payment</span>.<span class="ruby-identifier">member_id</span>  = (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mid</span>])
338:     <span class="ruby-ivar">@payment</span>.<span class="ruby-identifier">privilege_id</span> = <span class="ruby-constant">Member</span>.<span class="ruby-identifier">membership</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mid</span>]).<span class="ruby-identifier">privilege</span>.<span class="ruby-identifier">id</span>
339:     <span class="ruby-ivar">@pid</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">main_person</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mid</span>])
340:     <span class="ruby-comment cmt">#default to Subscription renewal</span>
341:     <span class="ruby-ivar">@payment</span>.<span class="ruby-identifier">paymenttype_id</span> = <span class="ruby-value">1</span>
342:     
343:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000018" class="method-detail">
        <a name="M000018"></a>

        <div class="method-heading">
          <a href="#M000018" class="method-signature">
          <span class="method-name">overdue_csv</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000018-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000018-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 432</span>
432:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">overdue_csv</span>
433:   
434:   <span class="ruby-ivar">@overdue</span> = <span class="ruby-constant">Member</span>.<span class="ruby-identifier">overduesubs</span>
435:   
436:   <span class="ruby-identifier">report</span> = <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>
437:   <span class="ruby-constant">CSV</span><span class="ruby-operator">::</span><span class="ruby-constant">Writer</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-identifier">report</span>,<span class="ruby-value str">','</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">title</span><span class="ruby-operator">|</span>
438: 
439:   <span class="ruby-identifier">title</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-value str">'First Name'</span>, <span class="ruby-value str">'Last Name'</span>, <span class="ruby-value str">'Home Phone'</span>, <span class="ruby-value str">'Mobile'</span>, <span class="ruby-value str">'Email'</span>,<span class="ruby-value str">'Address1'</span>,<span class="ruby-value str">'Address2'</span>,<span class="ruby-value str">'Address3'</span>,<span class="ruby-value str">'Address4'</span>, <span class="ruby-value str">'Member Class'</span>, <span class="ruby-value str">'Age'</span>, <span class="ruby-value str">'last Payment date'</span>]
440:     <span class="ruby-ivar">@overdue</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
441:       <span class="ruby-identifier">title</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">first_name</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">last_name</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">home_phone</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">mobile_phone</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">email_addr</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">address1</span>,<span class="ruby-identifier">c</span>.<span class="ruby-identifier">address2</span>,<span class="ruby-identifier">c</span>.<span class="ruby-identifier">address3</span>,<span class="ruby-identifier">c</span>.<span class="ruby-identifier">address4</span>,<span class="ruby-identifier">c</span>.<span class="ruby-identifier">privilege</span>.<span class="ruby-identifier">class_desc</span> ,<span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">age</span>,  <span class="ruby-identifier">c</span>.<span class="ruby-identifier">renew_date</span>.<span class="ruby-identifier">to_date</span>]
442:     <span class="ruby-keyword kw">end</span>
443: 
444:   <span class="ruby-keyword kw">end</span>
445:   <span class="ruby-identifier">report</span>.<span class="ruby-identifier">rewind</span>
446:   <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">report</span>.<span class="ruby-identifier">read</span>,<span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'text/csv; charset=iso-8859-1; header=present'</span>,<span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'overduemembers.csv'</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>)
447: 
448: 
449: 
450: <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000017" class="method-detail">
        <a name="M000017"></a>

        <div class="method-heading">
          <a href="#M000017" class="method-signature">
          <span class="method-name">overduememberships</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>===========================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000017-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000017-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 408</span>
408:  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">overduememberships</span>
409:    <span class="ruby-identifier">this_yr_start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span> 
410:    <span class="ruby-identifier">last_yr_start</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>
411:    
412:    <span class="ruby-ivar">@overdue</span> = <span class="ruby-constant">Member</span>.<span class="ruby-identifier">overduesubs</span>
413:   
414:   
415:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Export CSV file'</span>
416:     <span class="ruby-identifier">report</span> = <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>
417:     <span class="ruby-constant">CSV</span><span class="ruby-operator">::</span><span class="ruby-constant">Writer</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-identifier">report</span>,<span class="ruby-value str">','</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">title</span><span class="ruby-operator">|</span>
418:        <span class="ruby-identifier">title</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-value str">'First Name'</span>, <span class="ruby-value str">'Last Name'</span>, <span class="ruby-value str">'Home Phone'</span>, <span class="ruby-value str">'Mobile'</span>, <span class="ruby-value str">'Email'</span>,<span class="ruby-value str">'Address1'</span>,<span class="ruby-value str">'Address2'</span>,<span class="ruby-value str">'Address3'</span>,<span class="ruby-value str">'Address4'</span>, <span class="ruby-value str">'Member Class'</span>, <span class="ruby-value str">'Age'</span>, <span class="ruby-value str">'last Payment date'</span>]
419:        <span class="ruby-ivar">@overdue</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span>
420:           <span class="ruby-identifier">title</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">first_name</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">last_name</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">home_phone</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">mobile_phone</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">email_addr</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">address1</span>,<span class="ruby-identifier">c</span>.<span class="ruby-identifier">address2</span>,<span class="ruby-identifier">c</span>.<span class="ruby-identifier">address3</span>,<span class="ruby-identifier">c</span>.<span class="ruby-identifier">address4</span>,<span class="ruby-identifier">c</span>.<span class="ruby-identifier">privilege</span>.<span class="ruby-identifier">class_desc</span> ,<span class="ruby-identifier">c</span>.<span class="ruby-identifier">people</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">age</span>,  <span class="ruby-identifier">c</span>.<span class="ruby-identifier">renew_date</span>.<span class="ruby-identifier">to_date</span>]
421:        <span class="ruby-keyword kw">end</span>
422:     <span class="ruby-keyword kw">end</span>
423:     <span class="ruby-identifier">report</span>.<span class="ruby-identifier">rewind</span>
424:     <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">report</span>.<span class="ruby-identifier">read</span>,<span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'text/csv; charset=iso-8859-1; header=present'</span>,<span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'overduemembers.csv'</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>)
425:   <span class="ruby-keyword kw">else</span>
426:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
427:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span>
428:     <span class="ruby-keyword kw">end</span>
429:   <span class="ruby-keyword kw">end</span>
430: <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000008" class="method-detail">
        <a name="M000008"></a>

        <div class="method-heading">
          <a href="#M000008" class="method-signature">
          <span class="method-name">tot_by_member_class</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>=================================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000008-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000008-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 28</span>
28: <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tot_by_member_class</span>
29:     
30:     <span class="ruby-comment cmt">#Start year is 2007</span>
31:     
32:     <span class="ruby-ivar">@years</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">2006</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> 
33:     
34:     <span class="ruby-ivar">@month</span> = <span class="ruby-value str">''</span>
35:     
36:     <span class="ruby-ivar">@typestd</span> = []
37:     <span class="ruby-ivar">@yeartotaltd</span> = []
38:     <span class="ruby-ivar">@types</span> = []
39:     <span class="ruby-ivar">@yeartotal</span> = []
40:     
41:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Go'</span>
42:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date</span>][<span class="ruby-identifier">:month</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
43:         <span class="ruby-ivar">@endmonth</span> =   <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">month</span>.<span class="ruby-identifier">to_s</span>
44:         <span class="ruby-identifier">endday</span> =     <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">day</span>.<span class="ruby-identifier">to_s</span>
45:       <span class="ruby-keyword kw">end</span>
46:       <span class="ruby-ivar">@endmonth</span> =   <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:date</span>][<span class="ruby-identifier">:month</span>].<span class="ruby-identifier">to_s</span>
47:       <span class="ruby-identifier">endday</span> =     <span class="ruby-value str">&quot;31&quot;</span>
48:    <span class="ruby-keyword kw">else</span> 
49:       <span class="ruby-ivar">@endmonth</span> =   <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">month</span>.<span class="ruby-identifier">to_s</span>
50:       <span class="ruby-identifier">endday</span> =     <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">day</span>.<span class="ruby-identifier">to_s</span>
51:      
52:     <span class="ruby-keyword kw">end</span>
53:   
54:     <span class="ruby-ivar">@years</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">y</span><span class="ruby-operator">|</span>
55:       
56:           
57:       <span class="ruby-identifier">date_start</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>
58:       <span class="ruby-identifier">date_end</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;.&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@endmonth</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;.&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">endday</span>
59:       
60:       <span class="ruby-ivar">@typestd</span>[<span class="ruby-identifier">y</span>] = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">find</span>  <span class="ruby-identifier">:all</span>, 
61:                             <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;member_class, COUNT(*) as tot, SUM(amount) as money, privileges.class_desc&quot;</span>,
62:                             <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;inner join privileges ON privileges.id = payments.privilege_id&quot;</span>, 
63:                             <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-node">&quot;date_lodged &gt;= '#{date_start}' AND date_lodged &lt;= '#{date_end}' and privileges.member_class not in ('X','Y')&quot;</span>, 
64:                             <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;member_class, privileges.class_desc&quot;</span> ,<span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;member_class&quot;</span>
65:       
66:       
67:      <span class="ruby-ivar">@yeartotaltd</span>[<span class="ruby-identifier">y</span>] = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">find</span>  <span class="ruby-identifier">:all</span>,  
68:                           <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;COUNT(*) as tot, SUM(amount) as money&quot;</span>,
69:                           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;inner join privileges ON privileges.id = payments.privilege_id&quot;</span>, 
70:                           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot; date_lodged &gt;= '#{date_start}' AND date_lodged &lt;= '#{date_end}' and member_class not in ('X','Y') &quot;</span>
71:  
72:      
73:      <span class="ruby-identifier">date_start</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>
74:      <span class="ruby-identifier">date_end</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-12-31&quot;</span> 
75:   
76:      <span class="ruby-ivar">@types</span>[<span class="ruby-identifier">y</span>] = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">find</span>  <span class="ruby-identifier">:all</span>, 
77:                             <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;member_class, COUNT(*) as tot, SUM(amount) as money, privileges.class_desc&quot;</span>,
78:                             <span class="ruby-comment cmt">#:include =&gt; :privilege,</span>
79:                             <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;inner join privileges ON privileges.id = payments.privilege_id&quot;</span>,  
80:                             <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-node">&quot;date_lodged &gt;= '#{date_start}' AND date_lodged &lt;= '#{date_end}' and member_class not in ('X','Y')&quot;</span>, 
81:                             <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;member_class, class_desc&quot;</span> ,<span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'member_class'</span>
82:       
83:       
84:      <span class="ruby-ivar">@yeartotal</span>[<span class="ruby-identifier">y</span>] = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">find</span>  <span class="ruby-identifier">:all</span>,  
85:                           <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;COUNT(*) as tot, SUM(amount) as money&quot;</span>,
86:                           <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;inner join privileges ON privileges.id = payments.privilege_id&quot;</span>, 
87:                           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;date_lodged &gt;= '#{date_start}' AND date_lodged &lt;= '#{date_end}' and member_class not in ('X','Y') &quot;</span>
88:      
89:      <span class="ruby-keyword kw">end</span>
90: <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000021" class="method-detail">
        <a name="M000021"></a>

        <div class="method-heading">
          <a href="#M000021" class="method-signature">
          <span class="method-name">tot_by_member_class2</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000021-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000021-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 566</span>
566: <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tot_by_member_class2</span>
567:     
568: <span class="ruby-comment cmt">#Start year is 2007</span>
569:     <span class="ruby-ivar">@years</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">2007</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> 
570:     <span class="ruby-ivar">@types</span> = []
571:    <span class="ruby-identifier">classes</span> = []
572:    <span class="ruby-ivar">@values</span> = []
573:     
574:    
575:     <span class="ruby-ivar">@years</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">y</span><span class="ruby-operator">|</span>
576:       <span class="ruby-identifier">date_start</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>
577:       <span class="ruby-identifier">date_end</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">month</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">day</span>.<span class="ruby-identifier">to_s</span>
578:       
579:       <span class="ruby-ivar">@types</span>[<span class="ruby-identifier">y</span>] = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">count</span>  <span class="ruby-identifier">:all</span>,  
580:                             <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;inner join privileges ON privileges.id = payments.privilege_id&quot;</span>, 
581:                             <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-node">&quot;date_lodged &gt;= '#{date_start}' AND date_lodged &lt;= '#{date_end}' and member_class not in ('X','Y')&quot;</span>, 
582:                             <span class="ruby-identifier">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'class_desc'</span> ,<span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'member_class'</span>
583:       <span class="ruby-identifier">classes</span> = (<span class="ruby-ivar">@types</span>[<span class="ruby-identifier">y</span>].<span class="ruby-identifier">keys</span> <span class="ruby-operator">|</span> <span class="ruby-identifier">classes</span>).<span class="ruby-identifier">sort</span>
584:       
585:     <span class="ruby-keyword kw">end</span>
586:     
587:     <span class="ruby-comment cmt"># determine all classes available for all years</span>
588:     <span class="ruby-identifier">keys</span> = <span class="ruby-constant">Hash</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">classes</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">classes</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">v</span>),<span class="ruby-identifier">v</span>] }.<span class="ruby-identifier">flatten</span>].<span class="ruby-identifier">sort</span>
589:     
590:     
591:     <span class="ruby-comment cmt">#Create hash of values, using class description as key, if null, then set count to Zero.</span>
592:     <span class="ruby-ivar">@years</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
593:       <span class="ruby-ivar">@values</span>[<span class="ruby-identifier">x</span>] = [(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">x</span> ).<span class="ruby-identifier">to_s</span> , <span class="ruby-constant">Hash</span>[ <span class="ruby-operator">*</span><span class="ruby-identifier">keys</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">v</span>,<span class="ruby-ivar">@types</span>[<span class="ruby-identifier">x</span>][<span class="ruby-identifier">v</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@types</span>[<span class="ruby-identifier">x</span>][<span class="ruby-identifier">v</span>] ]}.<span class="ruby-identifier">flatten</span>]]
594:     <span class="ruby-keyword kw">end</span>
595:    <span class="ruby-identifier">puts</span>(<span class="ruby-value str">'here'</span>) 
596:   <span class="ruby-ivar">@years</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
597:      <span class="ruby-comment cmt"># keys.each do |k,v|</span>
598:      <span class="ruby-comment cmt">#    puts(values[x][k],v.to_s)</span>
599:      <span class="ruby-comment cmt">#    puts(values[x][v],k.to_s)</span>
600:      <span class="ruby-comment cmt">#    puts('k= %i',k)</span>
601:          <span class="ruby-comment cmt">#puts(values[x][0], values[k][v])</span>
602:      
603:      <span class="ruby-comment cmt"># display 5 years</span>
604:      
605:      <span class="ruby-ivar">@values</span>[<span class="ruby-identifier">x</span>][<span class="ruby-value">1</span>].<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span>,<span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
606:         <span class="ruby-identifier">puts</span>(<span class="ruby-identifier">x</span>,<span class="ruby-identifier">v</span>)
607:       <span class="ruby-keyword kw">end</span>
608:    <span class="ruby-keyword kw">end</span>
609:    
610:    <span class="ruby-comment cmt">#@years.times do |x| </span>
611:    <span class="ruby-comment cmt">#  puts(values[x][0])</span>
612:    <span class="ruby-comment cmt">#  puts(values[x][1].values)</span>
613:    <span class="ruby-comment cmt">#  puts(values[x][0], values[x][1].values)</span>
614:   <span class="ruby-comment cmt">#end</span>
615:   <span class="ruby-comment cmt">#@years.times do |x|    </span>
616:   <span class="ruby-comment cmt">#values[x][1].each do |v|</span>
617:   <span class="ruby-comment cmt">#  puts(v.keys)</span>
618:   <span class="ruby-comment cmt">#end</span>
619:   <span class="ruby-comment cmt">#end</span>
620: 
621:       
622: <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000013" class="method-detail">
        <a name="M000013"></a>

        <div class="method-heading">
          <a href="#M000013" class="method-signature">
          <span class="method-name">update</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>=================================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000013-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000013-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/payment_controller.rb, line 277</span>
277:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update</span>
278:     
279:     
280:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Save Changes'</span>
281:      
282:       <span class="ruby-ivar">@pm</span> = <span class="ruby-constant">Payment</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
283:       <span class="ruby-ivar">@pid</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:pid</span>]
284:       <span class="ruby-comment cmt">#selected row: </span>
285:      <span class="ruby-comment cmt"># @pm.privilege_id = params[:pm][:privilege_id]</span>
286:       
287:       <span class="ruby-identifier">bx</span> = <span class="ruby-ivar">@pm</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:pm</span>])
288:       
289:      
290:         <span class="ruby-comment cmt">#only update member class and renewed date  if payment is from current year. </span>
291:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@pm</span>.<span class="ruby-identifier">paymenttype_id</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> 
292:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@pm</span>.<span class="ruby-identifier">date_lodged</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> 
293:           <span class="ruby-identifier">current_year</span> = <span class="ruby-keyword kw">true</span>
294:           <span class="ruby-identifier">m</span> = <span class="ruby-ivar">@pm</span>.<span class="ruby-identifier">member</span>
295:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">privilege_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@pm</span>.<span class="ruby-identifier">privilege_id</span>
296:             <span class="ruby-identifier">mem_class_change</span> = <span class="ruby-keyword kw">true</span>
297:           <span class="ruby-keyword kw">end</span>
298:           <span class="ruby-identifier">m</span>.<span class="ruby-identifier">renew_date</span> = <span class="ruby-ivar">@pm</span>.<span class="ruby-identifier">date_lodged</span> 
299:           <span class="ruby-identifier">m</span>.<span class="ruby-identifier">privilege_id</span> = <span class="ruby-ivar">@pm</span>.<span class="ruby-identifier">privilege_id</span>
300:           <span class="ruby-identifier">m</span>.<span class="ruby-identifier">save</span> 
301:         <span class="ruby-keyword kw">end</span>
302:         <span class="ruby-keyword kw">end</span>
303:       
304:       
305:       
306:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_year</span> 
307:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">bx</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">m</span> 
308:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">mem_class_change</span>
309:             <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Payment was successfully updated, Membership class updated'</span>
310:             <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'person'</span>,<span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>,<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@pid</span>
311:       
312:             <span class="ruby-keyword kw">else</span> 
313:               <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Payment was successfully updated.'</span>
314:               <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'person'</span>,<span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>,<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@pid</span>
315:       
316:           <span class="ruby-keyword kw">end</span>
317:         <span class="ruby-keyword kw">end</span>
318:         
319:       <span class="ruby-keyword kw">elsif</span>
320:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">bx</span>
321:          <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Payment was successfully updated.'</span> 
322:          <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'person'</span>,<span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>,<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@pid</span>
323:       
324:         <span class="ruby-keyword kw">else</span>
325:          <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Problem updating payment.'</span>
326:          <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>,<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@pm</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:pid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@pid</span>
327:         <span class="ruby-keyword kw">end</span>
328:       <span class="ruby-keyword kw">else</span>
329:       <span class="ruby-keyword kw">end</span>
330:     <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt"># if</span>
331:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>