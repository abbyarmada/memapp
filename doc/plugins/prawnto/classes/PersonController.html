<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: PersonController</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">PersonController</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/app/controllers/person_controller_rb.html">
                app/controllers/person_controller.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                <a href="ApplicationController.html">
                ApplicationController
               </a>
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000131">bar_interface</a>&nbsp;&nbsp;
      <a href="#M000130">comms_csv</a>&nbsp;&nbsp;
      <a href="#M000123">create</a>&nbsp;&nbsp;
      <a href="#M000128">delete</a>&nbsp;&nbsp;
      <a href="#M000129">destroy</a>&nbsp;&nbsp;
      <a href="#M000126">edit</a>&nbsp;&nbsp;
      <a href="#M000121">index</a>&nbsp;&nbsp;
      <a href="#M000124">listm</a>&nbsp;&nbsp;
      <a href="#M000125">listmall</a>&nbsp;&nbsp;
      <a href="#M000122">new</a>&nbsp;&nbsp;
      <a href="#M000132">paid_up_extract</a>&nbsp;&nbsp;
      <a href="#M000127">update</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000131" class="method-detail">
        <a name="M000131"></a>

        <div class="method-heading">
          <a href="#M000131" class="method-signature">
          <span class="method-name">bar_interface</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000131-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000131-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 364</span>
364:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">bar_interface</span> 
365: 
366:   <span class="ruby-identifier">last_yr_start</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>
367:  
368: 
369: 
370:   <span class="ruby-ivar">@people</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, 
371:                         <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span>[<span class="ruby-identifier">:member</span> ,<span class="ruby-identifier">:peoplebarcard</span>],
372:                         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot; members.renew_date &gt;= '#{last_yr_start}'  &quot;</span>
373:    
374:     
375:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Export CSV file'</span>
376:     
377:     <span class="ruby-identifier">report</span> = <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>
378:     <span class="ruby-constant">CSV</span><span class="ruby-operator">::</span><span class="ruby-constant">Writer</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-identifier">report</span>,<span class="ruby-value str">','</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">extract</span><span class="ruby-operator">|</span>
379:       <span class="ruby-comment cmt"># header row</span>
380:       <span class="ruby-identifier">extract</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-value str">'BarBillies'</span>,<span class="ruby-value str">'MemClass'</span>,<span class="ruby-value str">'CardNo'</span>,<span class="ruby-value str">'LastName'</span>,<span class="ruby-value str">'FirstName'</span>,<span class="ruby-value str">'MemNumber'</span>,
381:      <span class="ruby-value str">'Salutation'</span>,<span class="ruby-value str">'HouseNameNo'</span>,<span class="ruby-value str">'StreetAddr'</span>,<span class="ruby-value str">'StreetAddr2'</span>,<span class="ruby-value str">'Town'</span>,<span class="ruby-value str">'City'</span>,<span class="ruby-value str">'PostCode'</span>,<span class="ruby-value str">'County'</span>,<span class="ruby-value str">'Country'</span>,
382:      <span class="ruby-value str">'RenewedCurrentYear'</span>,<span class="ruby-value str">'RenewedDate'</span>,<span class="ruby-value str">'DoB'</span>,<span class="ruby-value str">'occupation'</span>,
383:      <span class="ruby-value str">'HomePhone'</span>, <span class="ruby-value str">'Mobile'</span>,<span class="ruby-value str">'Email'</span>,<span class="ruby-value str">'Social'</span>,<span class="ruby-value str">'Racing'</span>,<span class="ruby-value str">'Cruiser'</span>,<span class="ruby-value str">'Dinghy'</span>,<span class="ruby-value str">'Junior'</span>,<span class="ruby-value str">'MembershipId'</span>
384:                 ]
385:      <span class="ruby-ivar">@people</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
386:         
387:         
388:         <span class="ruby-identifier">privilege</span> = <span class="ruby-constant">Privilege</span>.<span class="ruby-identifier">find_by_id</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">privilege_id</span>
389:         <span class="ruby-identifier">barreference</span> = <span class="ruby-identifier">privilege</span>.<span class="ruby-identifier">bar_reference</span>
390:         
391:         <span class="ruby-identifier">salutation</span> = <span class="ruby-value str">&quot;&quot;</span>
392:         <span class="ruby-identifier">renewedcurrentyear</span> = <span class="ruby-value str">&quot;&quot;</span>
393:         
394:  
395:         <span class="ruby-identifier">housenameno</span> = <span class="ruby-value str">&quot;&quot;</span>
396:         <span class="ruby-identifier">city</span> = <span class="ruby-value str">&quot;&quot;</span>
397:         <span class="ruby-identifier">town</span> =<span class="ruby-value str">&quot;&quot;</span>
398:         <span class="ruby-identifier">postcode</span> = <span class="ruby-value str">&quot;&quot;</span>
399:         <span class="ruby-identifier">county</span> = <span class="ruby-value str">&quot;&quot;</span>
400:         <span class="ruby-identifier">country</span> = <span class="ruby-value str">&quot;&quot;</span>
401:         
402:         
403:         <span class="ruby-comment cmt">#bar billies, based on member class  defaulted to N, set to Y if member class allows</span>
404:         <span class="ruby-comment cmt"># and membership renewed. </span>
405:         <span class="ruby-comment cmt"># new members do not get bar billies.</span>
406:         
407:         <span class="ruby-identifier">bar_billies</span> = <span class="ruby-value str">'N'</span>
408:         <span class="ruby-identifier">renewedcurrentyear</span>  = <span class="ruby-value str">'N'</span>
409:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">renew_date</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> 
410:           <span class="ruby-identifier">renewedcurrentyear</span>  = <span class="ruby-value str">'Y'</span>
411:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;m&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">renew_date</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Privilege</span>.<span class="ruby-identifier">billie_cutoff_date</span>
412:               <span class="ruby-identifier">bar_billies</span> = <span class="ruby-identifier">privilege</span>.<span class="ruby-identifier">bar_billies</span>
413:           <span class="ruby-keyword kw">end</span>
414:           
415:         <span class="ruby-keyword kw">end</span>
416:         
417:         <span class="ruby-identifier">occupation</span> = <span class="ruby-value str">&quot;&quot;</span>
418:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'m'</span> 
419:           <span class="ruby-identifier">occupation</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">occupation</span>
420:         <span class="ruby-keyword kw">end</span>
421:         
422:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">comm_prefs</span>
423:            <span class="ruby-ivar">@cp</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">comm_prefs</span>.<span class="ruby-identifier">upcase</span>
424:         <span class="ruby-keyword kw">end</span>
425:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/SO/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-ivar">@cp</span>)
426:           <span class="ruby-identifier">social</span> = <span class="ruby-value str">&quot;X&quot;</span>
427:         <span class="ruby-keyword kw">end</span>
428:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/CR/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-ivar">@cp</span>)
429:           <span class="ruby-identifier">cruising</span> = <span class="ruby-value str">&quot;X&quot;</span>
430:         <span class="ruby-keyword kw">end</span>
431:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/RA/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-ivar">@cp</span>)
432:           <span class="ruby-identifier">racing</span> = <span class="ruby-value str">&quot;X&quot;</span>
433:         <span class="ruby-keyword kw">end</span>
434:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/DI/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-ivar">@cp</span>)
435:           <span class="ruby-identifier">dinghy</span> = <span class="ruby-value str">&quot;X&quot;</span>
436:         <span class="ruby-keyword kw">end</span>
437:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/JU/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-ivar">@cp</span>)
438:           <span class="ruby-identifier">junior</span> = <span class="ruby-value str">&quot;X&quot;</span>
439:         <span class="ruby-keyword kw">end</span>
440:    
441:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">barreference</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> 
442:           <span class="ruby-identifier">extract</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">bar_billies</span>,<span class="ruby-identifier">barreference</span>, <span class="ruby-constant">BAR_CARD_PREFIX</span> <span class="ruby-operator">+</span> <span class="ruby-constant">BAR_CARD_SUFF_FORMAT</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">peoplebarcard</span>.<span class="ruby-identifier">barcard_id</span>.<span class="ruby-identifier">to_s</span> ,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">last_name</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">first_name</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>, 
443:           <span class="ruby-identifier">p</span>.<span class="ruby-identifier">salutation</span>(<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member_id</span>),<span class="ruby-identifier">housenameno</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">address1</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">address2</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">address3</span>,<span class="ruby-identifier">city</span>,<span class="ruby-identifier">postcode</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">address4</span>,<span class="ruby-identifier">country</span>,
444:           <span class="ruby-identifier">renewedcurrentyear</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">renew_date</span>.<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">to_s</span>,<span class="ruby-identifier">p</span>.<span class="ruby-constant">DOB</span>,<span class="ruby-identifier">occupation</span>,
445:           <span class="ruby-identifier">p</span>.<span class="ruby-identifier">home_phone</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">mobile_phone</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">email_addr</span>,<span class="ruby-identifier">social</span>,<span class="ruby-identifier">racing</span>,<span class="ruby-identifier">cruising</span>,<span class="ruby-identifier">dinghy</span>,<span class="ruby-identifier">junior</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">id</span> ]
446:         <span class="ruby-keyword kw">end</span>
447:      <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#do extract</span>
448:   <span class="ruby-identifier">report</span>.<span class="ruby-identifier">rewind</span>
449:   <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">report</span>.<span class="ruby-identifier">read</span>,<span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'text/csv; charset=iso-8859-1; header=present'</span>,<span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'BarInterface.csv'</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>)
450:   <span class="ruby-keyword kw">end</span>
451:   <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#if </span>
452:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000130" class="method-detail">
        <a name="M000130"></a>

        <div class="method-heading">
          <a href="#M000130" class="method-signature">
          <span class="method-name">comms_csv</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000130-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000130-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 311</span>
311: <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">comms_csv</span>
312:      <span class="ruby-comment cmt"># this generates the list for communications purposes</span>
313:     
314:     <span class="ruby-identifier">t</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
315:     <span class="ruby-identifier">this_yr_start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>
316: 
317:  <span class="ruby-ivar">@p2</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span>[<span class="ruby-identifier">:member</span>],
318:     <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'last_name'</span> ,<span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;members.renew_date &gt;=  '#{this_yr_start}' and (snd_txt = 'Y' or snd_eml = 'Y') and members.privilege_id &lt;&gt; 11 &quot;</span>
319:    
320:    <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Export CSV file'</span>
321:     
322:     
323:     <span class="ruby-identifier">report</span> = <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>
324:     <span class="ruby-constant">CSV</span><span class="ruby-operator">::</span><span class="ruby-constant">Writer</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-identifier">report</span>,<span class="ruby-value str">','</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">extract</span><span class="ruby-operator">|</span>
325:    
326:    <span class="ruby-comment cmt"># header row</span>
327:     <span class="ruby-identifier">extract</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-value str">'lastname'</span>,<span class="ruby-value str">'firstname'</span>,<span class="ruby-value str">'groups'</span>,<span class="ruby-value str">'mobilephone'</span>,<span class="ruby-value str">'emailaddress'</span> ]
328:        
329:     
330:       <span class="ruby-ivar">@p2</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
331:         <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">p</span>.<span class="ruby-identifier">mobile_phone</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">email_addr</span>).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
332:               
333:               <span class="ruby-ivar">@mf</span> = <span class="ruby-value str">&quot;&quot;</span>
334:               <span class="ruby-ivar">@ml</span> = <span class="ruby-value str">&quot;&quot;</span>
335:               <span class="ruby-ivar">@gr</span> = <span class="ruby-value str">&quot;&quot;</span>
336:               <span class="ruby-ivar">@mph</span> = <span class="ruby-value str">&quot;&quot;</span>
337:               <span class="ruby-ivar">@eml</span> = <span class="ruby-value str">&quot;&quot;</span>
338:               <span class="ruby-ivar">@mf</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">first_name</span> 
339:               <span class="ruby-ivar">@ml</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">last_name</span> 
340:               <span class="ruby-ivar">@gr</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">comm_prefs</span> 
341:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">snd_txt</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'Y'</span>
342:                 <span class="ruby-ivar">@mph</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">mobile_phone</span> 
343:               <span class="ruby-keyword kw">end</span>
344:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">snd_eml</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'Y'</span>
345:                 <span class="ruby-ivar">@eml</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">email_addr</span> 
346:               <span class="ruby-keyword kw">end</span>
347:               <span class="ruby-comment cmt"># no spaces around the commas</span>
348:               
349:               <span class="ruby-identifier">extract</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-ivar">@ml</span>, <span class="ruby-ivar">@mf</span>, <span class="ruby-ivar">@gr</span>,<span class="ruby-ivar">@mph</span>, <span class="ruby-ivar">@eml</span>] 
350:         <span class="ruby-keyword kw">end</span>
351:     <span class="ruby-keyword kw">end</span>
352:   <span class="ruby-keyword kw">end</span>
353:   
354: <span class="ruby-identifier">report</span>.<span class="ruby-identifier">rewind</span>
355: 
356:  <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">report</span>.<span class="ruby-identifier">read</span>,<span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'text/csv; charset=iso-8859-1; header=present'</span>,<span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'CommsList.csv'</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>)
357:  
358: <span class="ruby-keyword kw">end</span>
359: 
360:     
361: <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000123" class="method-detail">
        <a name="M000123"></a>

        <div class="method-heading">
          <a href="#M000123" class="method-signature">
          <span class="method-name">create</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000123-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000123-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 80</span>
80:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create</span>
81:     <span class="ruby-ivar">@person</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:person</span>])
82:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
83:       
84:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">save</span>
85:       
86:         <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">save</span>
87:         <span class="ruby-ivar">@barcard</span>.<span class="ruby-identifier">save</span>
88:         <span class="ruby-ivar">@peoplebarcard</span>.<span class="ruby-identifier">save</span>
89:         
90:         <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Person successfully created.'</span>
91:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span><span class="ruby-value str">'person'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>,<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">id</span>   }
92:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@person</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:created</span>, <span class="ruby-identifier">:location</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@person</span> }
93:       <span class="ruby-keyword kw">else</span>
94:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;new&quot;</span> }
95:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">errors</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:unprocessable_entity</span> }
96:       <span class="ruby-keyword kw">end</span>
97:     <span class="ruby-keyword kw">end</span>
98:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000128" class="method-detail">
        <a name="M000128"></a>

        <div class="method-heading">
          <a href="#M000128" class="method-signature">
          <span class="method-name">delete</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>================================================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000128-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000128-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 293</span>
293:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete</span>
294:     <span class="ruby-identifier">p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
295:     <span class="ruby-identifier">m</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>
296:     <span class="ruby-identifier">pp</span> = <span class="ruby-identifier">m</span>.<span class="ruby-identifier">people</span>.<span class="ruby-identifier">find_by_status</span> <span class="ruby-value str">'m'</span>
297:     <span class="ruby-ivar">@pid</span> = <span class="ruby-identifier">pp</span>.<span class="ruby-identifier">id</span>
298:     <span class="ruby-identifier">p</span>.<span class="ruby-identifier">destroy</span>
299:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>,<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@pid</span>
300:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000129" class="method-detail">
        <a name="M000129"></a>

        <div class="method-heading">
          <a href="#M000129" class="method-signature">
          <span class="method-name">destroy</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000129-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000129-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 302</span>
302:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">destroy</span>
303:     <span class="ruby-identifier">p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
304:     <span class="ruby-identifier">m</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>
305:     <span class="ruby-identifier">p</span>.<span class="ruby-identifier">destroy</span>
306:     <span class="ruby-identifier">m</span>.<span class="ruby-identifier">destroy</span>
307:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'listm'</span>
308:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000126" class="method-detail">
        <a name="M000126"></a>

        <div class="method-heading">
          <a href="#M000126" class="method-signature">
          <span class="method-name">edit</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000126-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000126-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 249</span>
249:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit</span>
250:    
251:     <span class="ruby-comment cmt"># get the person details</span>
252:     <span class="ruby-ivar">@person</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
253:     
254:     <span class="ruby-ivar">@member</span> = <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">member</span>
255:     <span class="ruby-ivar">@pbc</span> = <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">peoplebarcard</span>
256:     <span class="ruby-ivar">@pp</span> = <span class="ruby-ivar">@member</span>.<span class="ruby-identifier">people</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>
257:     <span class="ruby-ivar">@bb</span> = <span class="ruby-ivar">@member</span>.<span class="ruby-identifier">boats</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>
258:     <span class="ruby-ivar">@pmt</span> = <span class="ruby-ivar">@member</span>.<span class="ruby-identifier">payments</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,<span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'date_lodged DESC, id DESC'</span>
259:     <span class="ruby-ivar">@pid</span> = <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">id</span>
260:     <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">member_number</span> = <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">id</span>
261:     <span class="ruby-ivar">@mship</span> = <span class="ruby-ivar">@member</span>.<span class="ruby-identifier">id</span>
262: 
263: 
264:   <span class="ruby-comment cmt">#  respond_to do |format|    </span>
265:   <span class="ruby-comment cmt">#     format.html # edit.html.erb</span>
266:   <span class="ruby-comment cmt">#     format.iphone  { render  :layout =&gt; false }</span>
267:   <span class="ruby-comment cmt">#     format.xml  { render :xml =&gt; @person }</span>
268:   <span class="ruby-comment cmt">#  end</span>
269:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000121" class="method-detail">
        <a name="M000121"></a>

        <div class="method-heading">
          <a href="#M000121" class="method-signature">
          <span class="method-name">index</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>===========================================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000121-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000121-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 17</span>
17:    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">index</span>
18:   
19:      
20:     <span class="ruby-identifier">last_yr_start</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span> 
21:     <span class="ruby-identifier">lncondition</span> = [<span class="ruby-value str">&quot;AND last_name LIKE  &quot;</span>, <span class="ruby-node">&quot;'%#{params[:search]}%'&quot;</span>] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:search</span>].<span class="ruby-identifier">nil?</span>
22:     <span class="ruby-identifier">fncondition</span> = [<span class="ruby-value str">&quot;AND first_name LIKE  &quot;</span>, <span class="ruby-node">&quot;'%#{params[:searchfn]}%'&quot;</span>] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:searchfn</span>].<span class="ruby-identifier">nil?</span>
23:     <span class="ruby-identifier">mpcondition</span> = [<span class="ruby-value str">&quot;AND privileges.id =  &quot;</span>, <span class="ruby-node">&quot;#{(params[:searchmp][:privilege_id]) }&quot;</span>] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:searchmp</span>][<span class="ruby-identifier">:privilege_id</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-keyword kw">rescue</span> [] 
24:    <span class="ruby-comment cmt"># mpcondition = &quot;&quot;</span>
25: 
26:     <span class="ruby-identifier">mem_cond_select</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:person</span>][<span class="ruby-identifier">:mem_list_type</span>] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:person</span>].<span class="ruby-identifier">nil?</span> 
27:     <span class="ruby-ivar">@selected</span> = <span class="ruby-identifier">mem_cond_select</span> <span class="ruby-operator">||</span> <span class="ruby-value str">'c'</span>
28:     
29:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@selected</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'c'</span> 
30:       <span class="ruby-identifier">member_cond</span> = <span class="ruby-node">&quot;status = 'm'  AND ( members.renew_date  &gt;= '#{last_yr_start}' or members.renew_date is null) &quot;</span> 
31:     <span class="ruby-keyword kw">else</span>
32:       <span class="ruby-identifier">member_cond</span> = <span class="ruby-value str">&quot;status = 'm'   &quot;</span>
33:     <span class="ruby-keyword kw">end</span>
34:     
35:     <span class="ruby-identifier">fnorder</span> = [<span class="ruby-value str">&quot;first_name&quot;</span>] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:searchfn</span>].<span class="ruby-identifier">nil?</span>
36: 
37:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">fnorder</span>.<span class="ruby-identifier">blank?</span>
38:       <span class="ruby-identifier">order</span> = <span class="ruby-value str">&quot;first_name&quot;</span>
39:     <span class="ruby-keyword kw">else</span>
40:        <span class="ruby-identifier">order</span> = <span class="ruby-value str">&quot;last_name&quot;</span> 
41:     <span class="ruby-keyword kw">end</span>
42: 
43:     <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">paginate</span>  <span class="ruby-identifier">:page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:page</span>], 
44:           <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [{<span class="ruby-identifier">:member</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:privilege</span>},<span class="ruby-identifier">:peoplebarcard</span>] , 
45:           <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-node">&quot; #{member_cond} #{lncondition} #{fncondition} #{mpcondition} &quot;</span>, 
46:           <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot; #{order} &quot;</span>,
47:           <span class="ruby-identifier">:per_page</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">30</span>
48:           
49:       <span class="ruby-identifier">page</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:page</span>]
50:       
51:       <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>    
52:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> <span class="ruby-comment cmt"># index.html.erb</span>
53:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">iphone</span>  { <span class="ruby-identifier">render</span>  <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span> }
54:       <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:xml</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@p</span> }
55:       
56:     
57: 
58:     <span class="ruby-keyword kw">end</span>
59:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000124" class="method-detail">
        <a name="M000124"></a>

        <div class="method-heading">
          <a href="#M000124" class="method-signature">
          <span class="method-name">listm</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000124-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000124-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 101</span>
101:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">listm</span>
102:     
103:     
104:     
105:     <span class="ruby-comment cmt">#TODO   Change view to use date from members table for renewed date. </span>
106:     <span class="ruby-ivar">@mtop</span> = <span class="ruby-value">0</span> 
107:     
108:     <span class="ruby-comment cmt"># this is the main method</span>
109:     <span class="ruby-identifier">last_yr_start</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>
110:     
111:     <span class="ruby-comment cmt"># to identify all current paid up members (renew null check for members that have not yet paid) </span>
112:     <span class="ruby-identifier">member_cond</span> = <span class="ruby-node">&quot;status = 'm'  and ( members.renew_date  &gt;= '#{last_yr_start}' or members.renew_date is null)&quot;</span>
113:     
114:     
115:     <span class="ruby-ivar">@cond</span> = <span class="ruby-value str">&quot;BLANK&quot;</span>
116:     <span class="ruby-ivar">@mrows</span> = <span class="ruby-value">30</span> <span class="ruby-comment cmt"># rows per page@mrows = 20 # rows per page</span>
117:     
118:     <span class="ruby-comment cmt"># counts of members boats and people</span>
119:     <span class="ruby-ivar">@nm</span> = <span class="ruby-constant">Member</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,  
120:     <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'COUNT(*) as count'</span>,
121:     <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;members.renew_date  &gt;= '#{last_yr_start}'&quot;</span>
122:     
123:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mpos</span>] <span class="ruby-comment cmt"># if no parameter, use the session value</span>
124:       <span class="ruby-ivar">@mtop</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:mtop</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span> <span class="ruby-comment cmt"># if no session use 0</span>
125:     
126:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mpos</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;last&quot;</span>
127:        <span class="ruby-identifier">p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span>[<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-identifier">member_cond</span>
128:        <span class="ruby-ivar">@mtop</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@mrows</span>
129:     <span class="ruby-keyword kw">else</span>
130:       <span class="ruby-ivar">@mtop</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mpos</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span> <span class="ruby-comment cmt"># record at top of page</span>
131:       
132:     <span class="ruby-keyword kw">end</span>
133:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@mtop</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@mtop</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">end</span>
134:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:mtop</span>] = <span class="ruby-ivar">@mtop</span> 
135:     
136:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Find last_name'</span>
137:       <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,<span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-identifier">member_cond</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'last_name'</span>
138:       <span class="ruby-ivar">@pn</span> = <span class="ruby-value">0</span>
139:       <span class="ruby-ivar">@ln</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:person</span>][<span class="ruby-identifier">:last_name</span>].<span class="ruby-identifier">downcase</span>
140:       <span class="ruby-ivar">@ls</span> = <span class="ruby-ivar">@ln</span>.<span class="ruby-identifier">size</span>
141:       
142:       <span class="ruby-comment cmt"># find the position of the person with the specified last name</span>
143:       <span class="ruby-ivar">@p</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pp</span><span class="ruby-operator">|</span>
144:         <span class="ruby-ivar">@pn</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
145:         <span class="ruby-ivar">@shortp</span> = <span class="ruby-value str">&quot;&quot;</span>
146:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pp</span>.<span class="ruby-identifier">last_name</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@shortp</span> = <span class="ruby-identifier">pp</span>.<span class="ruby-identifier">last_name</span>[<span class="ruby-value">0</span>,<span class="ruby-ivar">@ls</span>].<span class="ruby-identifier">downcase</span> <span class="ruby-keyword kw">end</span>
147:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@shortp</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@ln</span>
148:           <span class="ruby-keyword kw">break</span>
149:         <span class="ruby-keyword kw">end</span> 
150:       <span class="ruby-keyword kw">end</span>
151:       <span class="ruby-ivar">@mtop</span> = <span class="ruby-ivar">@pn</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>
152:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@mtop</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@mtop</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">end</span>
153:       <span class="ruby-ivar">@cond</span> = <span class="ruby-ivar">@mtop</span>
154:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:mtop</span>] = <span class="ruby-ivar">@mtop</span>
155:       <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,  <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span>[<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mrows</span>, <span class="ruby-identifier">:offset</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mtop</span> , <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-identifier">member_cond</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'last_name'</span>
156:    
157:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Find first_name'</span>
158:       <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,<span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-identifier">member_cond</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'first_name'</span>
159:       <span class="ruby-ivar">@pn</span> = <span class="ruby-value">0</span>
160:       <span class="ruby-ivar">@ln</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:person</span>][<span class="ruby-identifier">:first_name</span>].<span class="ruby-identifier">downcase</span>
161:       <span class="ruby-ivar">@ls</span> = <span class="ruby-ivar">@ln</span>.<span class="ruby-identifier">size</span>
162:       
163:       <span class="ruby-comment cmt"># find the position of the person with the specified last name</span>
164:       <span class="ruby-ivar">@p</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pp</span><span class="ruby-operator">|</span>
165:         <span class="ruby-ivar">@pn</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
166:         <span class="ruby-ivar">@shortp</span> = <span class="ruby-value str">&quot;&quot;</span>
167:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pp</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@shortp</span> = <span class="ruby-identifier">pp</span>.<span class="ruby-identifier">first_name</span>[<span class="ruby-value">0</span>,<span class="ruby-ivar">@ls</span>].<span class="ruby-identifier">downcase</span> <span class="ruby-keyword kw">end</span>
168:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@shortp</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@ln</span>
169:           <span class="ruby-keyword kw">break</span>
170:         <span class="ruby-keyword kw">end</span> 
171:       <span class="ruby-keyword kw">end</span>
172:       <span class="ruby-ivar">@mtop</span> = <span class="ruby-ivar">@pn</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>
173:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@mtop</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@mtop</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">end</span>
174:       <span class="ruby-ivar">@cond</span> = <span class="ruby-ivar">@mtop</span>
175:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:mtop</span>] = <span class="ruby-ivar">@mtop</span>
176:       <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mrows</span>, <span class="ruby-identifier">:offset</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mtop</span> , <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-identifier">member_cond</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'first_name'</span>
177:     <span class="ruby-keyword kw">else</span>
178:       <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mrows</span>, <span class="ruby-identifier">:offset</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mtop</span> , <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span>  <span class="ruby-identifier">member_cond</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'last_name'</span>
179:     <span class="ruby-keyword kw">end</span>
180:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000125" class="method-detail">
        <a name="M000125"></a>

        <div class="method-heading">
          <a href="#M000125" class="method-signature">
          <span class="method-name">listmall</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000125-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000125-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 185</span>
185:  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">listmall</span>
186:     <span class="ruby-comment cmt"># this is the main method</span>
187:     <span class="ruby-ivar">@cond</span> = <span class="ruby-value str">&quot;BLANK&quot;</span>
188:     <span class="ruby-ivar">@mrows</span> = <span class="ruby-value">30</span> <span class="ruby-comment cmt"># rows per page@mrows = 20 # rows per page</span>
189:     
190:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mpos</span>] <span class="ruby-comment cmt"># if no parameter, use the session value</span>
191:       <span class="ruby-ivar">@mtop</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:mtop</span>] <span class="ruby-operator">||</span> <span class="ruby-value">0</span> <span class="ruby-comment cmt"># if no session use 0</span>
192:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mpos</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;last&quot;</span>
193:        <span class="ruby-identifier">p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,<span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'status = &quot;m&quot;'</span>
194:        <span class="ruby-ivar">@mtop</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@mrows</span>
195:     <span class="ruby-keyword kw">else</span>
196:       <span class="ruby-ivar">@mtop</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mpos</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">||</span> <span class="ruby-value">0</span> <span class="ruby-comment cmt"># record at top of page</span>
197:     <span class="ruby-keyword kw">end</span>
198:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@mtop</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@mtop</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">end</span>
199:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:mtop</span>] = <span class="ruby-ivar">@mtop</span> 
200:     
201:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Find last_name'</span>
202:       <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,<span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'status = &quot;m&quot;'</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'last_name'</span>
203:       <span class="ruby-ivar">@pn</span> = <span class="ruby-value">0</span>
204:       <span class="ruby-ivar">@ln</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:person</span>][<span class="ruby-identifier">:last_name</span>].<span class="ruby-identifier">downcase</span>
205:       <span class="ruby-ivar">@ls</span> = <span class="ruby-ivar">@ln</span>.<span class="ruby-identifier">size</span>
206:       
207:       <span class="ruby-comment cmt"># find the position of the person with the specified last name</span>
208:       <span class="ruby-ivar">@p</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pp</span><span class="ruby-operator">|</span>
209:         <span class="ruby-ivar">@pn</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
210:         <span class="ruby-ivar">@shortp</span> = <span class="ruby-value str">&quot;&quot;</span>
211:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pp</span>.<span class="ruby-identifier">last_name</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@shortp</span> = <span class="ruby-identifier">pp</span>.<span class="ruby-identifier">last_name</span>[<span class="ruby-value">0</span>,<span class="ruby-ivar">@ls</span>].<span class="ruby-identifier">downcase</span> <span class="ruby-keyword kw">end</span>
212:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@shortp</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@ln</span>
213:           <span class="ruby-keyword kw">break</span>
214:         <span class="ruby-keyword kw">end</span> 
215:       <span class="ruby-keyword kw">end</span>
216:       <span class="ruby-ivar">@mtop</span> = <span class="ruby-ivar">@pn</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>
217:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@mtop</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@mtop</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">end</span>
218:       <span class="ruby-ivar">@cond</span> = <span class="ruby-ivar">@mtop</span>
219:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:mtop</span>] = <span class="ruby-ivar">@mtop</span>
220:       <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,<span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mrows</span>, <span class="ruby-identifier">:offset</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mtop</span> , <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'status = &quot;m&quot;'</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'last_name'</span>
221:    
222:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Find first_name'</span>
223:       <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,<span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'status = &quot;m&quot;'</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'first_name'</span>
224:       <span class="ruby-ivar">@pn</span> = <span class="ruby-value">0</span>
225:       <span class="ruby-ivar">@ln</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:person</span>][<span class="ruby-identifier">:first_name</span>].<span class="ruby-identifier">downcase</span>
226:       <span class="ruby-ivar">@ls</span> = <span class="ruby-ivar">@ln</span>.<span class="ruby-identifier">size</span>
227:       
228:       <span class="ruby-comment cmt"># find the position of the person with the specified last name</span>
229:       <span class="ruby-ivar">@p</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">pp</span><span class="ruby-operator">|</span>
230:         <span class="ruby-ivar">@pn</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
231:         <span class="ruby-ivar">@shortp</span> = <span class="ruby-value str">&quot;&quot;</span>
232:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">pp</span>.<span class="ruby-identifier">first_name</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@shortp</span> = <span class="ruby-identifier">pp</span>.<span class="ruby-identifier">first_name</span>[<span class="ruby-value">0</span>,<span class="ruby-ivar">@ls</span>].<span class="ruby-identifier">downcase</span> <span class="ruby-keyword kw">end</span>
233:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@shortp</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@ln</span>
234:           <span class="ruby-keyword kw">break</span>
235:         <span class="ruby-keyword kw">end</span> 
236:       <span class="ruby-keyword kw">end</span>
237:       <span class="ruby-ivar">@mtop</span> = <span class="ruby-ivar">@pn</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>
238:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@mtop</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-keyword kw">then</span> <span class="ruby-ivar">@mtop</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">end</span>
239:       <span class="ruby-ivar">@cond</span> = <span class="ruby-ivar">@mtop</span>
240:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:mtop</span>] = <span class="ruby-ivar">@mtop</span>
241:       <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,<span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>], <span class="ruby-identifier">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mrows</span>, <span class="ruby-identifier">:offset</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mtop</span> , <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'status = &quot;m&quot;'</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'first_name'</span>
242:     <span class="ruby-keyword kw">else</span>
243:       <span class="ruby-ivar">@p</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>,<span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:member</span>,<span class="ruby-identifier">:peoplebarcard</span>],<span class="ruby-identifier">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mrows</span>, <span class="ruby-identifier">:offset</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@mtop</span> , <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'status = &quot;m&quot;'</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'last_name'</span>
244:     <span class="ruby-keyword kw">end</span>
245:       
246:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000122" class="method-detail">
        <a name="M000122"></a>

        <div class="method-heading">
          <a href="#M000122" class="method-signature">
          <span class="method-name">new</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000122-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000122-source">
<pre>
    <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 61</span>
61:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new</span>
62:     <span class="ruby-ivar">@person</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">new</span>
63: 
64:     <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">snd_txt</span> = <span class="ruby-value str">'Y'</span>
65:     <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">snd_eml</span> = <span class="ruby-value str">'Y'</span>
66:     <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">member_number</span> = <span class="ruby-value">0</span>
67:    
68:     <span class="ruby-ivar">@barcard</span> = <span class="ruby-constant">Barcard</span>.<span class="ruby-identifier">new</span>
69:     <span class="ruby-ivar">@peoplebarcard</span> = <span class="ruby-constant">Peoplebarcard</span>.<span class="ruby-identifier">new</span>
70:     <span class="ruby-ivar">@peoplebarcard</span>.<span class="ruby-identifier">people_id</span> = <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">id</span>
71:     <span class="ruby-ivar">@peoplebarcard</span>.<span class="ruby-identifier">barcard_id</span> = <span class="ruby-ivar">@barcard</span>.<span class="ruby-identifier">id</span>
72: 
73: 
74:     <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">member_id</span> = (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mid</span>]).<span class="ruby-identifier">to_i</span>
75:     <span class="ruby-ivar">@mship</span>  = (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:mid</span>])
76:     <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">member_id</span> = <span class="ruby-ivar">@mship</span>
77:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000132" class="method-detail">
        <a name="M000132"></a>

        <div class="method-heading">
          <a href="#M000132" class="method-signature">
          <span class="method-name">paid_up_extract</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000132-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000132-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 454</span>
454: <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">paid_up_extract</span>
455:   
456:   <span class="ruby-identifier">this_yr_start</span> = (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> ).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;-01-01&quot;</span>
457: 
458:   <span class="ruby-ivar">@people</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span> <span class="ruby-identifier">:all</span>, 
459:                         <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span>[<span class="ruby-identifier">:member</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:privilege</span> ],
460:                       <span class="ruby-comment cmt">#  :joins =&gt; &quot;inner join privileges ON privileges.id = members.privilege_id&quot;, </span>
461:                         <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot; ( members.renew_date &gt;= '#{this_yr_start}' or ( members.renew_date = null and members.year_joined = #{Time.now.year} ) )and member_class not in ('X','Y','T','E')  &quot;</span>
462:    
463:     
464:   <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:commit</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'Export CSV file'</span>
465:     
466:     <span class="ruby-identifier">report</span> = <span class="ruby-constant">StringIO</span>.<span class="ruby-identifier">new</span>
467:     <span class="ruby-constant">CSV</span><span class="ruby-operator">::</span><span class="ruby-constant">Writer</span>.<span class="ruby-identifier">generate</span>(<span class="ruby-identifier">report</span>,<span class="ruby-value str">','</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">extract</span><span class="ruby-operator">|</span>
468:       <span class="ruby-comment cmt"># header row</span>
469:       <span class="ruby-identifier">extract</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-value str">'BarBillies'</span>,<span class="ruby-value str">'MemClass'</span>,<span class="ruby-value str">'CardNo'</span>,<span class="ruby-value str">'LastName'</span>,<span class="ruby-value str">'FirstName'</span>,<span class="ruby-value str">'MemNumber'</span>,
470:      <span class="ruby-value str">'Salutation'</span>,<span class="ruby-value str">'HouseNameNo'</span>,<span class="ruby-value str">'StreetAddr'</span>,<span class="ruby-value str">'StreetAddr2'</span>,<span class="ruby-value str">'Town'</span>,<span class="ruby-value str">'City'</span>,<span class="ruby-value str">'PostCode'</span>,<span class="ruby-value str">'County'</span>,<span class="ruby-value str">'Country'</span>,
471:      <span class="ruby-value str">'RenewedCurrentYear'</span>,<span class="ruby-value str">'RenewedDate'</span>,<span class="ruby-value str">'DoB'</span>,<span class="ruby-value str">'occupation'</span>,
472:      <span class="ruby-value str">'HomePhone'</span>, <span class="ruby-value str">'Mobile'</span>,<span class="ruby-value str">'Email'</span>,<span class="ruby-value str">'Social'</span>,<span class="ruby-value str">'Racing'</span>,<span class="ruby-value str">'Cruiser'</span>,<span class="ruby-value str">'Dinghy'</span>,<span class="ruby-value str">'Junior'</span>
473:                 ]
474:      <span class="ruby-ivar">@people</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
475:         
476:         
477:         <span class="ruby-identifier">privilege</span> = <span class="ruby-constant">Privilege</span>.<span class="ruby-identifier">find_by_id</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">privilege_id</span>
478:   
479:         <span class="ruby-identifier">barreference</span> = <span class="ruby-identifier">privilege</span>.<span class="ruby-identifier">class_desc</span>
480:         
481:         <span class="ruby-identifier">renewedcurrentyear</span> = <span class="ruby-value str">&quot;&quot;</span>
482:         <span class="ruby-identifier">housenameno</span> = <span class="ruby-value str">&quot;&quot;</span>
483:         <span class="ruby-identifier">city</span> = <span class="ruby-value str">&quot;&quot;</span>
484:         <span class="ruby-identifier">town</span> =<span class="ruby-value str">&quot;&quot;</span>
485:         <span class="ruby-identifier">postcode</span> = <span class="ruby-value str">&quot;&quot;</span>
486:         <span class="ruby-identifier">county</span> = <span class="ruby-value str">&quot;&quot;</span>
487:         <span class="ruby-identifier">country</span> = <span class="ruby-value str">&quot;&quot;</span>
488:         
489:         <span class="ruby-comment cmt">#bar billies, based on member class  defaulted to N, set to Y if member class allows</span>
490:         <span class="ruby-comment cmt"># and membership renewed. </span>
491:         <span class="ruby-comment cmt"># new members do not get bar billies.</span>
492:         
493:         <span class="ruby-identifier">bar_billies</span> = <span class="ruby-value str">'N'</span>
494:         <span class="ruby-identifier">renewedcurrentyear</span>  = <span class="ruby-value str">'N'</span>
495:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">renew_date</span>.<span class="ruby-identifier">year</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">year</span> 
496:           <span class="ruby-identifier">renewedcurrentyear</span>  = <span class="ruby-value str">'Y'</span>
497:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;m&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">renew_date</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Privilege</span>.<span class="ruby-identifier">billie_cutoff_date</span>
498:               <span class="ruby-identifier">bar_billies</span> = <span class="ruby-identifier">privilege</span>.<span class="ruby-identifier">bar_billies</span>
499:           <span class="ruby-keyword kw">end</span>
500:         <span class="ruby-keyword kw">end</span>
501:         
502:         <span class="ruby-identifier">occupation</span> = <span class="ruby-value str">&quot;&quot;</span>
503:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value str">'m'</span> 
504:           <span class="ruby-identifier">occupation</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">occupation</span>
505:         <span class="ruby-keyword kw">end</span>
506:         
507:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">comm_prefs</span>
508:            <span class="ruby-ivar">@cp</span> = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">comm_prefs</span>.<span class="ruby-identifier">upcase</span>
509:         <span class="ruby-keyword kw">end</span>
510:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/SO/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-ivar">@cp</span>)
511:           <span class="ruby-identifier">social</span> = <span class="ruby-value str">&quot;X&quot;</span>
512:         <span class="ruby-keyword kw">end</span>
513:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/CR/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-ivar">@cp</span>)
514:           <span class="ruby-identifier">cruising</span> = <span class="ruby-value str">&quot;X&quot;</span>
515:         <span class="ruby-keyword kw">end</span>
516:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/RA/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-ivar">@cp</span>)
517:           <span class="ruby-identifier">racing</span> = <span class="ruby-value str">&quot;X&quot;</span>
518:         <span class="ruby-keyword kw">end</span>
519:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/DI/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-ivar">@cp</span>)
520:           <span class="ruby-identifier">dinghy</span> = <span class="ruby-value str">&quot;X&quot;</span>
521:         <span class="ruby-keyword kw">end</span>
522:         <span class="ruby-keyword kw">if</span> <span class="ruby-regexp re">/JU/</span>.<span class="ruby-identifier">match</span>(<span class="ruby-ivar">@cp</span>)
523:           <span class="ruby-identifier">junior</span> = <span class="ruby-value str">&quot;X&quot;</span>
524:         <span class="ruby-keyword kw">end</span>
525:         
526:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;m&quot;</span> 
527:           <span class="ruby-identifier">extract</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">bar_billies</span>,<span class="ruby-identifier">barreference</span>,  <span class="ruby-constant">BAR_CARD_PREFIX</span> <span class="ruby-operator">+</span> <span class="ruby-constant">BAR_CARD_SUFF_FORMAT</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">peoplebarcard</span>.<span class="ruby-identifier">barcard_id</span>.<span class="ruby-identifier">to_s</span> ,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">last_name</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">first_name</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>, 
528:           <span class="ruby-identifier">p</span>.<span class="ruby-identifier">salutation</span>(<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member_id</span>),<span class="ruby-identifier">housenameno</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">address1</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">address2</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">address3</span>,<span class="ruby-identifier">city</span>,<span class="ruby-identifier">postcode</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">address4</span>,<span class="ruby-identifier">country</span>,
529:           <span class="ruby-identifier">renewedcurrentyear</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">member</span>.<span class="ruby-identifier">renew_date</span>.<span class="ruby-identifier">to_date</span>.<span class="ruby-identifier">to_s</span>,<span class="ruby-identifier">p</span>.<span class="ruby-constant">DOB</span>,<span class="ruby-identifier">occupation</span>,
530:           <span class="ruby-identifier">p</span>.<span class="ruby-identifier">home_phone</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">mobile_phone</span>,<span class="ruby-identifier">p</span>.<span class="ruby-identifier">email_addr</span>,<span class="ruby-identifier">social</span>,<span class="ruby-identifier">racing</span>,<span class="ruby-identifier">cruising</span>,<span class="ruby-identifier">dinghy</span>,<span class="ruby-identifier">junior</span> ]
531:         <span class="ruby-keyword kw">end</span>
532:      <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#do extract</span>
533:   <span class="ruby-identifier">report</span>.<span class="ruby-identifier">rewind</span>
534:   <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">report</span>.<span class="ruby-identifier">read</span>,<span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'text/csv; charset=iso-8859-1; header=present'</span>,<span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'PaidUpMembers.csv'</span>, <span class="ruby-identifier">:disposition</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'attachment'</span>, <span class="ruby-identifier">:encoding</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'utf8'</span>)
535:   <span class="ruby-keyword kw">end</span>
536:   <span class="ruby-keyword kw">end</span> <span class="ruby-comment cmt">#if </span>
537:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000127" class="method-detail">
        <a name="M000127"></a>

        <div class="method-heading">
          <a href="#M000127" class="method-signature">
          <span class="method-name">update</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <h6>================================================</h6>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000127-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000127-source">
<pre>
     <span class="ruby-comment cmt"># File app/controllers/person_controller.rb, line 274</span>
274:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update</span>
275:   <span class="ruby-ivar">@person</span> = <span class="ruby-constant">Person</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
276:   
277:     <span class="ruby-ivar">@member</span> = <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">member</span>
278: 
279:     <span class="ruby-identifier">respond_to</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">format</span><span class="ruby-operator">|</span>
280:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:person</span>]) <span class="ruby-keyword kw">and</span> <span class="ruby-ivar">@member</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:member</span>]) 
281:         <span class="ruby-identifier">flash</span>[<span class="ruby-identifier">:notice</span>] = <span class="ruby-value str">'Person was successfully updated.'</span>
282:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span><span class="ruby-value str">'person'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>,<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">id</span>  }
283:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">xml</span>  { <span class="ruby-identifier">head</span> <span class="ruby-identifier">:ok</span> }
284:       <span class="ruby-keyword kw">else</span>
285:         <span class="ruby-identifier">format</span>.<span class="ruby-identifier">html</span> { <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;edit&quot;</span> ,<span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@person</span>.<span class="ruby-identifier">id</span>  }
286: <span class="ruby-comment cmt">#        format.xml  { render :xml =&gt; @person.errors, :status =&gt; :unprocessable_entity }</span>
287:       <span class="ruby-keyword kw">end</span>
288:     <span class="ruby-keyword kw">end</span>
289:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>